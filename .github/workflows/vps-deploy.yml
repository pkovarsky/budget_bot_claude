name: ðŸš€ Deploy to VPS

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ðŸ§ª Tests (same as before but faster)
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ—„ï¸ Create test database
      run: python -c "from database import create_tables; create_tables()"
        
    - name: ðŸ§ª Run critical tests
      run: |
        python -m pytest tests/test_memory_system.py -v
        python scripts/migrate_memory_system.py

  # ðŸ—ï¸ Build and Push Docker Image
  build:
    name: ðŸ—ï¸ Build & Push Image
    runs-on: ubuntu-latest
    needs: test
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: ðŸ—ï¸ Build and push
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ðŸš€ Deploy to VPS
  deploy:
    name: ðŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ“ Prepare deployment files
      run: |
        # Create deployment package
        mkdir -p deploy
        cp docker-compose.prod.yml deploy/
        cp -r nginx deploy/ || echo "nginx config not found"
        cp -r monitoring deploy/ || echo "monitoring config not found"
        cp -r scripts deploy/
        
        # Create environment file for production
        cat > deploy/.env << EOF
        TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD }}
        TZ=${{ vars.TZ || 'Europe/Amsterdam' }}
        GITHUB_REPOSITORY=${{ github.repository }}
        EOF
        
    - name: ðŸ“¦ Create deployment archive
      run: |
        cd deploy
        tar -czf ../deployment.tar.gz .
        
    - name: ðŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        
    - name: ðŸ“¤ Upload deployment files
      run: |
        scp deployment.tar.gz ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/
        
    - name: ðŸš€ Deploy on VPS
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          set -e
          
          # Navigate to app directory
          sudo mkdir -p /opt/budget-bot
          cd /opt/budget-bot
          
          # Backup current deployment
          if [ -f docker-compose.prod.yml ]; then
            echo "ðŸ“¦ Creating backup..."
            sudo cp docker-compose.prod.yml docker-compose.backup.yml
          fi
          
          # Extract new deployment
          echo "ðŸ“¥ Extracting deployment files..."
          sudo tar -xzf /tmp/deployment.tar.gz
          sudo chown -R $USER:$USER .
          
          # Setup directory structure
          echo "ðŸ“ Setting up directories..."
          sudo mkdir -p /opt/budget-bot/{data/{postgres,redis,grafana,prometheus,exports,charts},logs/nginx,backups}
          sudo chown -R $USER:$USER /opt/budget-bot
          
          # Pull latest images
          echo "ðŸ³ Pulling latest images..."
          docker-compose -f docker-compose.prod.yml pull
          
          # Stop old containers gracefully
          echo "ðŸ›‘ Stopping old containers..."
          docker-compose -f docker-compose.prod.yml down --timeout 30 || true
          
          # Run database migrations
          echo "ðŸ—„ï¸ Running migrations..."
          docker-compose -f docker-compose.prod.yml run --rm budget-bot python scripts/migrate_memory_system.py || echo "Migration failed or not needed"
          
          # Start new containers
          echo "ðŸš€ Starting new containers..."
          docker-compose -f docker-compose.prod.yml up -d
          
          # Wait for services to be ready
          echo "â³ Waiting for services..."
          sleep 30
          
          # Check health
          echo "ðŸ¥ Checking health..."
          docker-compose -f docker-compose.prod.yml ps
          
          # Clean up
          rm -f /tmp/deployment.tar.gz
          docker system prune -f
          
          echo "âœ… Deployment completed successfully!"
        ENDSSH
        
    - name: ðŸ” Verify deployment
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          cd /opt/budget-bot
          
          # Check if containers are running
          echo "ðŸ“Š Container status:"
          docker-compose -f docker-compose.prod.yml ps
          
          # Check logs for any errors
          echo "ðŸ“ Recent logs:"
          docker-compose -f docker-compose.prod.yml logs --tail=20 budget-bot
          
          # Test database connection
          echo "ðŸ—„ï¸ Testing database..."
          docker-compose -f docker-compose.prod.yml exec -T budget-bot python -c "
from database import get_db_session
try:
    db = get_db_session()
    db.execute('SELECT 1')
    print('âœ… Database connection: OK')
    db.close()
except Exception as e:
    print(f'âŒ Database connection: {e}')
    exit(1)
" || echo "Database test failed"
        ENDSSH
        
    - name: ðŸ“Š Post-deployment monitoring
      if: always()
      run: |
        # Send notification to monitoring system
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "deployment": {
              "status": "${{ job.status }}",
              "repository": "${{ github.repository }}",
              "commit": "${{ github.sha }}",
              "environment": "${{ github.event.inputs.environment || 'production' }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }
          }' \
          "${{ secrets.WEBHOOK_URL }}" || echo "Webhook notification failed"

  # ðŸ”„ Rollback job (manual trigger)
  rollback:
    name: ðŸ”„ Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event.inputs.environment
    environment: 
      name: ${{ github.event.inputs.environment }}
    
    steps:
    - name: ðŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        
    - name: ðŸ”„ Perform rollback
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          cd /opt/budget-bot
          
          if [ -f docker-compose.backup.yml ]; then
            echo "ðŸ”„ Rolling back to previous version..."
            
            # Stop current containers
            docker-compose -f docker-compose.prod.yml down
            
            # Restore backup
            cp docker-compose.backup.yml docker-compose.prod.yml
            
            # Start with backup configuration
            docker-compose -f docker-compose.prod.yml up -d
            
            echo "âœ… Rollback completed!"
          else
            echo "âŒ No backup found for rollback"
            exit 1
          fi
        ENDSSH

  # ðŸ“ˆ Performance monitoring
  monitor:
    name: ðŸ“ˆ Monitor Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - name: ðŸ¥ Health check
      run: |
        # Wait a bit for services to stabilize
        sleep 60
        
        # Check if we can reach the application
        # (This would be a health endpoint if you had one)
        echo "Monitoring deployment health..."
        
    - name: ðŸ“Š Resource monitoring
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          cd /opt/budget-bot
          
          echo "ðŸ’¾ Disk usage:"
          df -h /opt/budget-bot
          
          echo "ðŸ³ Container resource usage:"
          docker stats --no-stream
          
          echo "ðŸ“Š Volume sizes:"
          sudo du -sh /opt/budget-bot/data/*
        ENDSSH